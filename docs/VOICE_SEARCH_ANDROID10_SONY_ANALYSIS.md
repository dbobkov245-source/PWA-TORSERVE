# Voice Search: Sony Android 10 vs TCL Android 12

Дата: 15 февраля 2026  
Статус: Актуализировано после фикса prompt-fallback; открыт UX-дефект popup-flow на Sony Android 10

## 1) Контекст и цель

В проекте зафиксирована разница UX голосового поиска на Android TV:

- TCL 65C7K (Android 12): распознавание и возврат результата происходят в ожидаемом темпе.
- Sony KD-65XH9505 (Android 10): при системной строке голоса микрофон слушает, но результат в приложении часто появляется только после закрытия системного экрана.

Цель документа:

- зафиксировать актуальное состояние после уже сделанного фикса `prompt(...)`;
- объяснить текущую причину странного поведения на Sony;
- закрепить целевой план Hybrid voice-flow (`popup:false` -> fallback `popup:true` через 4000ms).

## 2) Симптомы (фактическое поведение)

### TCL 65C7K (Android 12)

- Нажатие на кнопку микрофона в приложении.
- Срабатывает системное распознавание.
- Транскрипт возвращается в приложение и запускается поиск.
- Сценарий завершается без дополнительных действий пользователя.

### Sony KD-65XH9505 (Android 10)

- Нажатие на кнопку микрофона в приложении.
- Появляется верхняя системная строка поиска с иконкой микрофона.
- Иконка микрофона мигает, явного результата в UI приложения сразу нет.
- Если дождаться или нажать `Back`, приложение получает результат и открывает найденный фильм.

## 3) Ожидаемое поведение

- На Sony и TCL голосовой поиск должен завершаться одинаково предсказуемо.
- Успешная фраза должна давать результат без обязательного ручного `Back`.
- Ошибки `cancel/no speech/no match` должны закрываться управляемо, без агрессивного UX.

## 4) Техническая карта текущей реализации

### Точки входа голосового поиска

- Глобальный микрофон: `client/src/App.jsx`
- Микрофон в панели поиска: `client/src/components/SearchPanel.jsx`

### Единая точка voice-логики

- Хук: `client/src/hooks/useVoiceSearch.jsx`
- Оба входа используют `startListening()` из этого хука.

### Текущая конфигурация распознавания

- Плагин: `@capacitor-community/speech-recognition` (`^6.0.1`)
- Вызов `SpeechRecognition.start(...)` сейчас использует:
  - `language: 'ru-RU'`
  - `partialResults: false`
  - `popup: true`

### Нативная механика, критичная для UX

- При `popup:true` Android-плагин идет через `startActivityForResult(...)`.
- Финальный результат/ошибка в приложение возвращаются через Activity result callback.
- Пока системная speech Activity не закрыта, Promise на стороне приложения может не завершаться.

### Целевой интерфейс (документируемый контракт, planned)

```ts
startListening(options?): Promise<string | null>
```

Планируемые опции:

- `mode: 'hybrid' | 'nonPopup' | 'popup'`
- `fallbackTimeoutMs?: number`
- `language?: string`
- `prompt?: string`

Планируемые дефолты:

- `mode='hybrid'`
- `fallbackTimeoutMs=4000`
- `language='ru-RU'`

## 5) Выводы по корневой причине (актуализировано)

### Вывод A (закрытый дефект)

Старый дефект с `prompt(...)` в текущем коде уже закрыт: голосовая логика централизована в `useVoiceSearch`, fallback в системный `prompt` удален.

### Вывод B (текущий primary-дефект)

Текущая проблема на Sony связана не с `prompt(...)`, а с `popup:true`:

- распознавание идет в системной Activity;
- результат возвращается в приложение только после `ACTIVITY_RESULT`;
- из-за этого пользователь видит задержанный эффект и часто воспринимает `Back` как «кнопку завершения поиска».

### Вывод C (влияние speech engine)

По логам повторяются `NO_SPEECH_DETECTED` и пустые финальные результаты. Это усиливает задержку и может переводить сценарий в повторные циклы системного экрана.

### Вывод D (архитектурный статус)

Раздвоение логики между `App.jsx` и `SearchPanel.jsx` закрыто (оба используют один хук), но внутри хука все еще один режим (`popup:true`), который недостаточно стабилен для Sony Android 10.

## 6) Подтверждающие факты из кода (актуальные)

- `client/src/hooks/useVoiceSearch.jsx`: `SpeechRecognition.start(...)` вызывается с `popup: true`.
- `client/src/hooks/useVoiceSearch.jsx`: ошибки `"0"`/`Cancelled` обрабатываются как silent cancel (`null`).
- `client/src/App.jsx`: `handleVoiceSearch` ожидает `await startListening()` и продолжает поиск только после завершения Promise.
- `client/src/components/SearchPanel.jsx`: `startVoiceSearch` также работает через `await startListening()`.

Следствие: при popup-flow весь UX зависит от момента закрытия системной speech Activity.

## 7) Подтверждение из логов (прогон 14.02.2026)

Источник: `consolelog.md`, `bugreport.md`.

### Таймлайн (обновленный)

1. Приложение вызывает плагин:

- `SpeechRecognition.start(...)` с `language: ru-RU`, `popup:true`.

2. Система запускает speech intent:

- создается `ResolverActivity` для `android.speech.action.RECOGNIZE_SPEECH`;
- затем стартует `com.google.android.tts/...GoogleTTSActivity`.

3. Внутри speech activity фиксируются пустые результаты:

- `#onResults empty final recognition results`
- `NO_SPEECH_DETECTED`

4. Возврат в приложение происходит после закрытия speech activity:

- в логе есть `wm_on_activity_result_called: ... com.torserve.pwa.MainActivity, ACTIVITY_RESULT`.

5. После возврата плагин отправляет ошибку `{"message":"0"}`:

- это трактуется как `cancel/result-not-ok` для popup-flow.

### Что это подтверждает

- На Sony системные `ResolverActivity` и `GoogleTTSActivity` запускаются штатно.
- Ключевая UX-проблема в том, что приложение получает развязку сценария только при Activity result.
- Отсюда эффект «ничего не происходит, пока не закрыть/не дождаться».

## 8) Дополнительные наблюдения

- Централизация voice-логики уже выполнена (`useVoiceSearch`).
- Документация до этого апдейта оставалась в состоянии «до фикса prompt». Этот документ обновляет источник истины.

## 9) План исправления (Hybrid Plan v2)

### Этап 1: Non-popup primary (`popup:false`) + timeout 4000ms

- Первичный запуск распознавания выполнять без popup (`popup:false`).
- Ждать финальный результат до `4000ms`.
- Если нет финального текста за timeout, завершать primary-попытку контролируемо и переходить на fallback.

Критерий готовности:

- На Sony успешный голосовой кейс чаще закрывается без ручного `Back`.

### Этап 2: Fallback popup (`popup:true`) только для timeout/empty/no-match

- `popup:true` не использовать как первичный режим.
- Включать popup только если primary завершился как timeout/empty/no-match.

Критерий готовности:

- Popup используется как резервный путь, а не основной UX.

### Этап 3: Нормализация ошибок без агрессивного UX

- Нормализовать ветки: `cancel`, `no speech`, `no match`, `service error`.
- `cancel/no speech/no match` возвращать как управляемый `null`-результат без побочных экранов.
- Ошибки сервиса показывать как in-app уведомление (toast/banner), без блокирующих диалогов.

Критерий готовности:

- Ошибки не переводят пользователя в неочевидный поток действий.

### Этап 4: Единая телеметрия voice-flow

- Добавить структурированные этапы:
  - `primary_start`
  - `primary_timeout`
  - `fallback_start`
  - `resolved`
  - `cancelled`
  - `error`
- Логи должны позволять быстро понять, на каком шаге сценарий «залип».

Критерий готовности:

- По логам можно однозначно определить причину каждого неуспешного запуска.

### Этап 5: QA-матрица Sony/TCL

- Sony Android 10 и TCL Android 12 прогоняются одной матрицей кейсов.
- Обязательные проверки:
  - успешная фраза на Sony без обязательного `Back` в большинстве запусков;
  - `silence/no-match` не открывает IME и не зависает;
  - `cancel` по `Back` возвращает в исходный UI без побочных экранов;
  - оба входа (глобальный mic и SearchPanel mic) идентичны по логике.

Критерий готовности:

- Оба устройства проходят единый сценарий с предсказуемым UX.

## 10) План верификации после фиксов

### Smoke

- Нажать микрофон в `App` (глобальный).
- Произнести фильм на русском.
- Проверить, что результат появляется без ручного `Back` в нормальном потоке.

### SearchPanel

- Открыть `SearchPanel`, нажать локальный микрофон.
- Проверить такой же flow и тот же результат по поведению.

### Negative

- Silence: нажать микрофон и молчать.
- Убедиться, что нет зависания и нет IME-ветки.

### Cancel

- Запустить голос и отменить `Back`.
- Убедиться, что UI возвращается корректно и не открывает лишние экраны.

### Regression

- Проверить обычный текстовый поиск и D-Pad навигацию.
- Проверить отсутствие регрессий на TCL Android 12.

## 11) Явные допущения и выбранные значения

- Код в рамках этой задачи не меняется: фиксируется только документация.
- Выбран целевой подход: `Hybrid`.
- Зафиксирован timeout fallback: `4.0s` (`4000ms`).
- Нативный Android bridge на этом этапе не меняется.

## 12) Резюме

- Дефект с IME через `prompt(...)` закрыт в текущем коде.
- Актуальный дефект: delayed completion в popup-flow на Sony Android 10 из-за возврата результата через `ACTIVITY_RESULT`.
- Утвержден целевой default:
  - `mode='hybrid'`
  - `fallbackTimeoutMs=4000`
  - primary `popup:false`, fallback `popup:true`.
