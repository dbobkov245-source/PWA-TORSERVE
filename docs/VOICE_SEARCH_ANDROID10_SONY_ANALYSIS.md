# Voice Search: Sony Android 10 vs TCL Android 12

Дата: 14 февраля 2026
Статус: Анализ проблемы и план работ (без внесения фиксов в код в этом документе)

## 1) Контекст и цель

В проекте обнаружена разница поведения голосового поиска на двух Android TV устройствах:

- TCL 65C7K (Android 12): голосовой поиск работает стабильно.
- Sony KD-65XH9505 (Android 10): голосовой сценарий ломается и уходит в экранную клавиатуру.

Цель этого документа:

- Зафиксировать наблюдаемые симптомы.
- Дать технические выводы на основании текущего кода.
- Подготовить пошаговый план исправления и проверки.

## 2) Симптомы (фактическое поведение)

### TCL 65C7K (Android 12)

- Нажатие на кнопку микрофона в приложении.
- Открывается системное окно голосового распознавания.
- Речь транскрибируется.
- Результат применяется в поиске внутри приложения.
- Пользовательский сценарий завершен успешно.

### Sony KD-65XH9505 (Android 10)

- Нажатие на кнопку микрофона в приложении.
- Появляется строка поиска с иконкой микрофона вверху экрана.
- После речи нет корректного результата в приложении.
- Далее появляется экранная клавиатура.
- При нажатии микрофона в клавиатуре распознавание русского языка работает некорректно.
- Затем открывается меню ввода текста.

## 3) Ожидаемое поведение

- На обоих устройствах голосовой поиск должен завершаться в приложении одним и тем же UX-сценарием.
- При ошибке распознавания пользователь должен получать понятное сообщение в UI приложения, а не перевод в системный IME-поток.

## 4) Техническая карта текущей реализации

### Точки входа голосового поиска

- Верхний микрофон (глобальный поиск): `client/src/App.jsx`
- Микрофон в панели поиска: `client/src/components/SearchPanel.jsx`

### Используемый плагин

- `@capacitor-community/speech-recognition` (версия `^6.0.1`)
- Конфигурация вызова в проекте: `language: 'ru-RU'`, `partialResults: false`, `popup: true`

### Нативная часть плагина (важно для диагностики)

- При `popup: true` используется `startActivityForResult(...)` с `RecognizerIntent.ACTION_RECOGNIZE_SPEECH`.
- Если `resultCode != RESULT_OK`, вызов уходит в `reject(...)`.
- В проекте этот `reject(...)` перехватывается `catch`.

## 5) Выводы по корневой причине

## Вывод A (критичный)

В `client/src/App.jsx` при любой ошибке распознавания используется fallback на `prompt(...)`.

Следствие:

- На Android TV это приводит к переходу в системный текстовый ввод (IME/клавиатура).
- Дальше работает уже не тот voice-движок, который ожидался в сценарии приложения.
- Именно этим объясняется наблюдаемая цепочка на Sony: voice popup -> fallback -> клавиатура -> микрофон клавиатуры с другой языковой конфигурацией.

## Вывод B (критичный)

В `client/src/components/SearchPanel.jsx` ошибки распознавания фактически глотаются без явной обратной связи пользователю.

Следствие:

- Пользователь видит, что после речи “ничего не происходит”.
- Поведение воспринимается как случайный сбой.

## Вывод C (высокий риск)

Язык задан жестко как `ru-RU`, но в текущем коде нет проверки поддержки языка на конкретном устройстве/движке до старта.

Следствие:

- На Android 10 TV возможно падение в нежелательные системные fallback-сценарии.

## Вывод D (архитектурный риск)

Голосовая логика дублирована в двух местах (`App.jsx` и `SearchPanel.jsx`) и ведет себя по-разному.

Следствие:

- Нестабильный UX.
- Рост риска регрессий при точечных правках.

## 6) Подтверждающие факты из кода

### Проблемный fallback в `prompt(...)`

- `client/src/App.jsx`: ветки с `prompt(...)` в fallback на ошибку/недоступность.

### Обработка ошибок в панели поиска

- `client/src/components/SearchPanel.jsx`: `catch { setIsListening(false) }` без сообщения/плана B.

### Поведение Android-плагина

- `client/node_modules/@capacitor-community/speech-recognition/android/.../SpeechRecognition.java`
- При popup-режиме результат обрабатывается через Activity Result, неуспех вызывает reject.

## 7) Подтверждение из логов (прогон 14.02.2026, без речи)

Важно: этот конкретный прогон выполнялся без произнесения фразы (нажатие голосового поиска без речи).  
Следовательно, логи доказывают сценарий `no speech`, но не дают финальный вывод о качестве распознавания русской речи при реальном диктовании.

### Таймлайн (что зафиксировано)

1. Приложение вызывает voice plugin:

- `available -> requestPermissions -> start` с `language: ru-RU`, `popup: true`.

2. Система поднимает `RECOGNIZE_SPEECH` через Resolver:

- Видны как минимум 2 обработчика: `com.google.android.tts` и `com.google.android.katniss`.

3. Выбранный поток (`com.google.android.tts`) запускается и принимает `ru-RU`.

4. Сессия завершается с пустым финальным результатом:

- `#onResults empty final recognition results`
- `NO_SPEECH_DETECTED`

5. В приложение возвращается ошибка плагина:

- `error: {"message":"0"}` (фактически отмена/неуспешный Activity result для popup-flow).

6. После возврата показывается IME у `com.torserve.pwa`:

- Поднимается клавиатура.
- Активная раскладка: `en-US`.

### Что это подтверждает

- Проблемная цепочка воспроизводится документально:  
  `voice popup -> no speech -> plugin error/cancel -> fallback/ввод текста -> IME (en-US)`.
- Основная гипотеза про нежелательный переход в IME после voice-fail подтверждена логами.

### Что это НЕ подтверждает

- Что русский язык в распознавателе всегда работает плохо при нормальной речи.  
  Для этого нужен отдельный прогон с реальным голосом (не silence).

### Отдельная наблюдаемая деталь

- В логах есть сообщения о недоступности offline language pack для `ru-RU` (`error 12`).  
  Это может ухудшать стабильность/latency на части устройств и усиливает необходимость graceful fallback в UI.

## 8) Дополнительные наблюдения по качеству проекта

### Тесты

- `client` unit-тесты: проходят (`vitest`, 30/30).

### Lint

- `client` lint падает с большим количеством ошибок.
- Значительная часть шума из сгенерированных Android-ассетов, которые сейчас не исключены из ESLint.

Риск:

- Сложнее видеть реальные регрессии в изменяемых исходниках.

## 9) План исправления (поэтапно)

## Этап 1: Стабилизация voice UX (минимальный безопасный фикс)

- Убрать `prompt(...)` fallback в Android TV голосовом потоке.
- При ошибке распознавания показывать явный in-app статус (toast/banner): “Голос не распознан, попробуйте снова”.
- Не переводить пользователя в IME-клавиатуру автоматически.
- Отдельно обработать `error.message === "0"` как `cancel/no-result` без открытия текстового ввода.

Критерий готовности:

- На Sony при ошибке не открывается клавиатурный ввод через `prompt(...)`.

## Этап 2: Единый voice service

- Вынести голосовую логику в единый модуль, например `client/src/utils/voiceSearch.js`.
- Использовать этот модуль и в `App.jsx`, и в `SearchPanel.jsx`.
- Унифицировать ошибки, таймауты, тексты сообщений и формат результата.

Критерий готовности:

- Одинаковая логика на всех точках входа.

## Этап 3: Language/engine guard

- Добавить preflight перед `start(...)`:
- Проверка доступности speech-сервиса.
- Проверка разрешения микрофона.
- Проверка поддержки русского (где возможно, через список языков или контролируемый fallback).
- Порядок выбора языка: `ru-RU` -> `ru_RU` -> `Locale.getDefault()`.
- Логировать, был ли использован online-only режим (нет offline LP) для выбранной локали.

Критерий готовности:

- При неподдерживаемом языке пользователь получает управляемое сообщение, не silent-fail.

## Этап 4: Наблюдаемость и диагностика

- Добавить структурированные логи по voice-flow:
- device model, Android version, язык запроса, тип ошибки плагина.
- Добавить счетчики: start/success/no-match/cancel/error.
- Добавить флаг, показывался ли системный Resolver перед стартом распознавания.
- Логировать `resultCode` из popup Activity (где доступно).

Критерий готовности:

- По логам можно быстро отличить “нет речи”, “cancel”, “language mismatch”, “service unavailable”.

## Этап 5: QA-матрица по устройствам

- Прогон на TCL Android 12.
- Прогон на Sony Android 10.
- Проверки:
- Успешное распознавание русского.
- Нет автоматического ухода в IME fallback при ошибке.
- Повторный запуск голоса после 1-2 неудачных попыток.
- Отдельный кейс: запуск без речи (silence) не должен открывать `prompt`/IME.
- Отдельный кейс: отмена voice-экрана (Back) не должна открывать IME.

Критерий готовности:

- Оба ТВ проходят один и тот же сценарий без расхождения UX.

## Этап 6: Resolver hardening (Android TV)

- Минимизировать зависимость от системного chooser для voice-ввода:
- либо через controlled fallback ветку (`popup: false`) при ошибках popup-flow,
- либо через собственный native bridge для speech intent с детальной обработкой `resultCode`.
- Цель: одинаковое поведение без “случайного” перехода в чужой speech UI.

Критерий готовности:

- На проблемном устройстве не возникает петля `Resolver -> cancel/no-speech -> IME`.

## Этап 7: Улучшение качества CI сигналов (вне голоса, но важно)

- Исключить из ESLint сгенерированные каталоги Android:
- `client/android/app/build/**`
- `client/android/app/src/main/assets/**`
- Сохранить строгие правила для `client/src/**`.

Критерий готовности:

- Линтер перестает “шуметь” нецелевыми файлами и показывает реальные дефекты исходников.

## 10) План верификации после фиксов

## Smoke (быстрый)

- Нажать микрофон на домашнем экране.
- Произнести фильм на русском.
- Убедиться, что открывается нужный результат.

## Negative

- Нажать микрофон и молчать.
- Проверить, что отображается понятное сообщение, а не `prompt`/IME.
- Нажать микрофон и сразу закрыть voice-экран кнопкой Back.
- Проверить, что приложение остается в исходном UI без открытия клавиатуры.

## Recovery

- Повторить 3-5 запусков подряд после ошибок.
- Убедиться, что голосовой сценарий продолжает работать.

## Regression

- Проверить, что обычный текстовый поиск и D-Pad навигация не деградировали.

## 11) Риски и ограничения

- Android TV 10 и Android TV 12 могут использовать разные speech services и OEM-обвязку.
- Поведение `popup: true` частично зависит от системного распознавателя, который не контролируется приложением.
- На части устройств может отсутствовать offline language pack для `ru-RU`, что повышает шанс no-speech/cancel в нестабильной сети.
- Полная унификация возможна только через строгий in-app error handling и отказ от `prompt` fallback в TV-режиме.

## 12) Резюме

Проблема на Sony воспроизводится логически и технически объясняется текущим кодом:

- Ошибка popup-распознавания -> fallback в `prompt(...)` -> системная клавиатура/IME voice.

Основной приоритет:

- Стабилизировать обработку ошибок и убрать переход в IME fallback.
- Централизовать voice-flow и добавить управляемую диагностику.
- Отдельно закрыть сценарий `no speech` и `cancel` без открытия IME.
