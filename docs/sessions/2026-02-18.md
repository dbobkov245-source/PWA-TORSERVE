# Session 2026-02-18: Torrent Stability + Local Library Recovery

## Что было сделано

1. Устранен регресс удаления торрентов:
   - `DELETE /api/delete/:infoHash` теперь по умолчанию делает **hard delete**.
   - soft keep-alive сохранен только по явному `?soft=1`.
2. Исправлен парсинг `rutor`:
   - корректно извлекается размер, даже если в строке сначала идет счетчик комментариев.
3. Переработан preflight/ранжирование выдачи:
   - preflight проверяет top-N по `seeders`, а не по порядку провайдеров;
   - `risky` с `0 peers` опускается ниже `unchecked`;
   - TTL cache preflight снижен до 60s (через `PREFLIGHT_CACHE_TTL_MS`).
4. Добавлено восстановление локальной медиатеки:
   - новый модуль `server/localLibrary.js`;
   - локальные видео из `DOWNLOAD_PATH` попадают в `/api/status`;
   - стрим локальных файлов работает через текущий `/stream/:infoHash/:fileIndex`;
   - добавлен `POST /api/library/rescan`.

## Почему пропадали ранее скачанные фильмы

UI показывает в основном активные torrent engines. Если magnet/engine не восстановился после перезапуска, файл на диске оставался, но в `/api/status` его не было.  
Теперь локальные файлы индексируются отдельно и отображаются как `isReady: true`, `progress: 1`.

## Проверки

- `node server/__tests__/run-tests.js` -> **26 passed, 0 failed**
- `npm run client:build` -> **OK**
- NAS:
  - `POST /api/library/rescan` -> найдено локальных элементов
  - `/api/status` возвращает локальные файлы с `progress=1`
  - `GET /stream/<local_infoHash>/0` с `Range` -> `206 Partial Content`, корректный video content-type

## Важное про клиент

Изменения в клиентском коде действительно вносились (`SearchPanel smart-sort + playability badge`).  
Также на NAS уже выложен свежий `client/dist`, поэтому пересборка клиента прямо сейчас не обязательна для уже задеплоенного контейнера.
