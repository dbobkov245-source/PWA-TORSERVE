# Session 2026-02-11: FIX-6 — dns-only lookup injection

## Проблема
RuTracker, Rutor, TorLook не возвращали результатов. `providersCount: 1` — circuit breaker отключал провайдеров.

## Корневая причина
`dns-only` режим в `doh.js` был сломан by design:
- DoH резолвил IP правильно, но **не использовал его**
- Node.js делал СИСТЕМНЫЙ DNS lookup → ISP poisoning → мгновенный timeout (~1с)
- Circuit breaker отключал провайдера после 3 отказов

## Что сделано

### FIX-6: `lookup` injection (`server/utils/doh.js`)
Инжекция DoH-резолвленного IP через `requestOptions.lookup` в Node.js `http.request()`:
- URL остаётся с hostname → TLS SNI корректный → Cloudflare OK
- TCP коннект на DoH-IP → ISP DNS не используется

### API key masking (`server/routes/proxy.js`)
`api_key=c3bec...` → `api_key=***` в логах.

### Документация
- Обновлён Акт 19 в `POSTER_BATTLE_HISTORY.md` (FIX-6 root cause + fix)
- Session log в `roadmap.md`

## Статус: ⏳ Ожидает проверки
Фикс применён, syntax check пройден. Нужно:
1. Убедиться что `doh.js` на NAS обновлён (`docker exec torserve grep resolvedForDNS /app/server/utils/doh.js`)
2. Включить `DOH_DEBUG=true` для диагностики
3. Рестарт + тест поиска

## Файлы
- `server/utils/doh.js` — FIX-6
- `server/routes/proxy.js` — API key mask
- `POSTER_BATTLE_HISTORY.md` — Акт 19
